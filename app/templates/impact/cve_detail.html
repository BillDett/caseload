{% extends "base.html" %}

{% block title %}{{ cve_id }} - Vulnerability Impact - CaseLoad{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('impact.index') }}">Vulnerability Impact</a></li>
                <li class="breadcrumb-item active">{{ cve_id }}</li>
            </ol>
        </nav>
        <h1><i class="bi bi-bullseye"></i> {{ cve_id }}</h1>
        <p class="text-muted">Blast radius analysis</p>
    </div>
</div>

{% if result.error %}
<div class="row">
    <div class="col">
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> {{ result.error }}
        </div>
        <a href="{{ url_for('impact.index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Search
        </a>
    </div>
</div>
{% else %}

<div class="row mb-4">
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Severity</h6>
                {% if result.summary.severity %}
                {% set sev_lower = result.summary.severity.lower() %}
                <span class="badge bg-{{ 'danger' if sev_lower == 'critical' else 'warning' if sev_lower == 'important' else 'info' if sev_lower == 'moderate' else 'secondary' }} fs-5">
                    {{ result.summary.severity }}
                </span>
                {% else %}
                <span class="badge bg-secondary fs-5">Unknown</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Affected Teams</h6>
                <h2>{{ result.summary.affected_teams }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Affected Projects</h6>
                <h2>{{ result.summary.affected_projects }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Total Trackers</h6>
                <h2>{{ result.summary.total_trackers }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Open Trackers</h6>
                <h2 class="{{ 'text-danger' if result.summary.open_trackers > 0 else 'text-success' }}">
                    {{ result.summary.open_trackers }}
                </h2>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted">Create Date Skew</h6>
                <h2>{{ result.summary.date_skew_days if result.summary.date_skew_days is not none else 'N/A' }}{% if result.summary.date_skew_days is not none %} days{% endif %}</h2>
            </div>
        </div>
    </div>
</div>

{% if result.summary.is_embargoed %}
<div class="row mb-4">
    <div class="col">
        <div class="alert alert-danger">
            <i class="bi bi-lock"></i> <strong>Embargoed CVE</strong> - This vulnerability is under embargo. Handle with care.
        </div>
    </div>
</div>
{% endif %}

<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-bar-chart-steps"></i> Tracker Timeline Flow</h5>
            </div>
            <div class="card-body">
                <div id="chart" style="height: 500px;"></div>
            </div>
        </div>
    </div>
</div>

{% if result.data.creation_timeline_json %}
<div class="row mb-4">
    <div class="col-md-9">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-calendar-range"></i> Tracker Creation Timeline</h5>
            </div>
            <div class="card-body">
                <div id="timeline-chart"></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-clock-history"></i> Timeline Stats</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        {% if result.data.timeline_stats %}
                        <tr>
                            <td>Total Trackers</td>
                            <td><strong>{{ result.data.timeline_stats.total_trackers }}</strong></td>
                        </tr>
                        <tr>
                            <td>First Created</td>
                            <td><strong>{{ result.data.timeline_stats.first_created }}</strong></td>
                        </tr>
                        <tr>
                            <td>Last Created</td>
                            <td><strong>{{ result.data.timeline_stats.last_created }}</strong></td>
                        </tr>
                        <tr>
                            <td>Date Range</td>
                            <td><strong>{{ result.data.timeline_stats.date_range_days }}</strong> days</td>
                        </tr>
                        {% if result.data.timeline_stats.std_dev_days is defined %}
                        <tr>
                            <td>Std Deviation</td>
                            <td><strong>{{ result.data.timeline_stats.std_dev_days }}</strong> days</td>
                        </tr>
                        {% endif %}
                        {% endif %}
                    </tbody>
                </table>
                <p class="text-muted small mt-2 mb-0">
                    Shows when each tracker was created, grouped by project.
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if result.data.team_impact %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-people"></i> Team Impact</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Team</th>
                            <th>Trackers</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for team, count in result.data.team_impact.items() %}
                        <tr>
                            <td>
                                {% if result.data.team_urls and result.data.team_urls[team] %}
                                <a href="{{ result.data.team_urls[team] }}" target="_blank">{{ team }} <i class="bi bi-box-arrow-up-right small"></i></a>
                                {% else %}
                                {{ team }}
                                {% endif %}
                            </td>
                            <td>{{ count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endif %}
{% endblock %}

{% block scripts %}
{% if result.chart_json %}
<script>
    var chartData = {{ result.chart_json | safe }};
    Plotly.newPlot('chart', chartData.data, chartData.layout, {responsive: true});
</script>
{% endif %}
{% if result.data.creation_timeline_json %}
<script>
    var timelineData = {{ result.data.creation_timeline_json | safe }};
    Plotly.newPlot('timeline-chart', timelineData.data, timelineData.layout, {responsive: true});
</script>
{% endif %}
{% endblock %}
